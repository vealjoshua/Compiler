#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "scanner.h"
#include "token.h"

tokenType** scanner(char* str, int lineNumber, int* numOfTokens)
{
	tokenType** tokenHEAD = malloc(sizeof(tokenType**));
	tokenType** tokenArr = tokenHEAD;

	int FATAble[28][29] = 
	{				/*0		1		2		3		4		5		6		7		8		9		10		11		12		13		14		15		16		17		18		19		20		21		22		23		24		25		26		27		28*/
					/*' '	L		D		_		EOF		=		<		>		!		:		+		-		*		/		&		%		.		(		)		,		{		}		;		[		]		#		\n		\0		other*/
		/*0 - WS*/	{0,		1,		2,		-1,		1000,	3,		4,		5,		6,		7,		8,		9,		10,		11,		12,		13,		14,		15,		16,		17,		18,		19,		20,		21,		22,		23,		0,		0,		-1000},
		/*1 - ID*/	{1001,	1,		1,		1,		1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001,	1001, 	-1000},
		/*2 - DIG*/	{1002,	-2,		2,		-2,		1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	1002,	-1000},
		/*3 - =*/	{1003,	1003,	1003,	1003,	1003,	24,		1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	1003,	-1000},
		/*4 - <*/	{1004,	1004,	1004,	1004,	1004,	25,		1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	1004,	-1000},
		/*5 - >*/	{1005,	1005,	1005,	1005,	1005,	26,		1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	1005,	-1000},
		/*6 - !*/	{-3,	-3,		-3,		-3,		-3,		27,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-3,		-1000},
		/*7 - :*/	{1006,	11006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	1006,	-1000},
		/*8 - +*/	{1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	1007,	-1000},
		/*9 - -*/	{1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	1008,	-1000},
		/*10 - **/	{1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	1009,	-1000},
		/*11 - /*/	{1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	1010,	-1000},
		/*12 - &*/	{1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	1011,	-1000},
		/*13 - %*/	{1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	1012,	-1000},
		/*14 - .*/	{1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	1013,	-1000},
		/*15 - (*/	{1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	1014,	-1000},
		/*16 - )*/	{1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	1015,	-1000},
		/*17 - ,*/	{1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	1016,	-1000},
		/*18 - {*/	{1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	1017,	-1000},
		/*19 - }*/	{1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	1018,	-1000},
		/*20 - ;*/	{1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	1019,	-1000},
		/*21 - [*/	{1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	1020,	-1000},
		/*22 - ]*/	{1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	1021,	-1000},
		/*23 - #*/	{23,	23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		23,		1022,	-4,		-4,		-4},
		/*24 - ==*/	{1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	1023,	-1000},
		/*25 - <=*/	{1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	1024,	-1000},
		/*26 - >=*/	{1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	1025,	-1000},
		/*27 - !=*/	{1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	1026,	-1000}
	};

	int state = 0;
	int nextState = 0;
	int tokBeg = 0;
	int tokEnd = 0;
	char* strHEAD = str;
	while(*str != '\0') {
		int charNum = determineCharNum(*str);
		int nextCharNum = determineCharNum(str[1]);
		state = FATAble[state][charNum];
		if (state != 23 && nextState == 1022)
			state = 0;
		nextState = FATAble[state][nextCharNum];

		// testing purposes
		printf("state = %d, char = '%c', charNum = %d\n", state, *str, charNum);
		printf("nextState = %d, nextChar = '%c', nextCharNum = %d\n", nextState, str[1], nextCharNum);

		if (nextState == -4)
		{
				printf("Error: Comment never closed.\n");
				exit(-1);
		}
		if (nextState < 0 || nextState > 999)
		{
			tokEnd++;
			// Allocating memory
			tokenType* token = malloc(sizeof(tokenType));
			if (token == NULL) {
		        fprintf(stderr, "Failed to allocate memory for token.\n");
		        exit(-1);
	    	}
	    	token->tokenID = nextState;
	    	if (token->tokenID == 1022)
	    	{
					tokEnd++;
			    	str++;

	    	}
	    	token->tokenInstance = (char* ) malloc(sizeof(char *) * (tokEnd - tokBeg + 1));
			if (token->tokenInstance == NULL) {
			    fprintf(stderr, "Failed to allocate memory for token.\n");
			    exit(-1);
		    }
			token->lineNum = lineNumber;
			for (tokBeg; tokBeg < tokEnd; tokBeg++)
				token->tokenInstance[tokBeg] = strHEAD[tokBeg];
			if (token->tokenID == 1001)
				token->tokenID = testIfKeyword(token->tokenInstance);

			strHEAD = str;
			strHEAD++;
			tokBeg = 0, tokEnd = 0;
			*tokenArr++ = token;
			*numOfTokens += 1;

			state = 0;
		}
		else if(state == 0 && (charNum == 0 || charNum == 26))
		{ // skip white spaces and new lines
			strHEAD++;
			state = 0;
		}
		else
		{
			state = nextState;
			tokEnd++;
		}
		str++;
	}
	return tokenHEAD;
}

int testIfKeyword(char* id)
{
	if (strcmp(id, "Begin") == 0)
		return 2000;
	else if (strcmp(id, "End") == 0)
		return 2001;
	else if (strcmp(id, "Check") == 0)
		return 2002;
	else if (strcmp(id, "Loop") == 0)
		return 2003;
	else if (strcmp(id, "Void") == 0)
		return 2004;
	else if (strcmp(id, "Var") == 0)
		return 2005;
	else if (strcmp(id, "Return") == 0)
		return 2006;
	else if (strcmp(id, "Input") == 0)
		return 2007;
	else if (strcmp(id, "Output") == 0)
		return 2008;
	else if (strcmp(id, "Program") == 0)
		return 2009;
	else
		return 1001;
}

int determineCharNum(char str)
{
	if (str == ' ')
			return 0;
		else if (isalpha(str))
			return 1;
		else if (isdigit(str))
			return 2;
		else if (str == '_')
			return 3;
		else if (str == EOF)
			return 4;
		else if (str =='=')
			return 5;
		else if (str == '<')
			return 6;
		else if (str == '>')
			return 7;
		else if (str == '!')
			return 8;
		else if (str == ':')
			return 9;
		else if (str == '+')
			return 10;
		else if (str == '-')
			return 11;
		else if (str == '*')
			return 12;
		else if (str == '/')
			return 13;
		else if (str == '&')
			return 14;
		else if (str == '%')
			return 15;
		else if (str == '.')
			return 16;
		else if (str == '(')
			return 17;
		else if (str == ')')
			return 18;
		else if (str == ',')
			return 19;
		else if (str == '{')
			return 20;
		else if (str == '}')
			return 21;
		else if (str == ';')
			return 22;
		else if (str == '[')
			return 23;
		else if (str == ']')
			return 24;
		else if (str == '#')
			return 25;
		else if (str == '\n')
			return 26;
		else if (str == '\0')
			return 27;
		else // Other
			return 28;
}